<div class="col-md-12 mb-4">
    <div class="card h-100">
        <div class="card-body">
            <h5 class="card-title">Customer Preference Clusters</h5>
            <div id="clusterHeatmap" style="height: 500px;"></div>
            <div id="heatmapMessage" class="text-muted small mt-2"></div>
        </div>
    </div>
</div>

{{ cluster_heatmap.x|json_script:"heatmapX" }}
{{ cluster_heatmap.y|json_script:"heatmapY" }}
{{ cluster_heatmap.z|json_script:"heatmapZ" }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const heatmapDiv = document.getElementById('clusterHeatmap');
    const messageDiv = document.getElementById('heatmapMessage');
    try {
        const x = JSON.parse(document.getElementById('heatmapX').textContent);
        const y = JSON.parse(document.getElementById('heatmapY').textContent);
        const z = JSON.parse(document.getElementById('heatmapZ').textContent);
        const zmax = {{ cluster_heatmap.zmax|default:100 }};

        // Validate data
        if (!x.length || !y.length || !z.length) {
            throw new Error('Missing heatmap data');
        }

        // Force minimum color contrast
        const colorscale = [
            [0, '#F0F0F0'],
            [0.01, '#FFEDA0'],  // Show faint color even for 1%
            [0.1, '#FEB24C'],
            [0.5, '#FC4E2A'],
            [1, '#B10026']
        ];

        Plotly.newPlot(heatmapDiv, [{
            x: x,
            y: y,
            z: z,
            type: 'heatmap',
            colorscale: colorscale,
            zmin: 0,
            zmax: zmax,
            hoverinfo: 'x+y+z',
            colorbar: {
                title: 'Probability (%)',
                tickformat: '.1f%'
            }
        }], {
            margin: {t: 30, b: 120, l: 120, r: 30},
            xaxis: {
                title: 'Items',
                tickangle: 45,
                automargin: true
            },
            yaxis: {
                title: 'Users',
                automargin: true
            }
        });

        messageDiv.textContent = 'Displaying ' + y.length + ' users and ' + x.length + ' items';

    } catch (error) {
        heatmapDiv.style.display = 'none';
        messageDiv.textContent = `Error loading heatmap: \${error.message}`;
        console.error('Heatmap error:', error);
    }
});
</script>