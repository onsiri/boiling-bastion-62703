<div class="col-md-12 mb-4">
    <div class="card h-100">
        <div class="card-body">
            <h5 class="card-title">Customer Preference Clusters</h5>
            <div id="clusterHeatmap" style="height: 500px;"></div>
            <div id="heatmapMessage" class="text-muted small mt-2"></div>
        </div>
    </div>
</div>

{{ cluster_heatmap.x|json_script:"heatmapX" }}
{{ cluster_heatmap.y|json_script:"heatmapY" }}
{{ cluster_heatmap.z|json_script:"heatmapZ" }}
{{ cluster_heatmap.x_labels|json_script:"heatmapXLabels" }}
{{ cluster_heatmap.y_labels|json_script:"heatmapYLabels" }}
{{ top_predicted_items|json_script:"topPredictedItems" }}
{{ item_affinity.z|json_script:"itemAffinityZ" }}
{{ item_affinity.x|json_script:"itemAffinityX" }}
{{ item_affinity.y|json_script:"itemAffinityY" }}

<div class="col-md-12 mb-4">
    <div class="card h-100">
        <div class="card-body">
            <h5 class="card-title">Top Predicted Items</h5>
            <div id="topPredictedItemsChart" style="height: 500px;"></div>
            <div id="topPredictedItemsMessage" class="text-muted small mt-2"></div>
        </div>
    </div>
</div>

<div class="col-md-12 mb-4">
    <div class="card h-100">
        <div class="card-body">
            <h5 class="card-title">Item Affinity</h5>
            <div id="itemAffinityChart" style="height: 500px;"></div>
            <div id="itemAffinityMessage" class="text-muted small mt-2"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const heatmapDiv = document.getElementById('clusterHeatmap');
    const messageDiv = document.getElementById('heatmapMessage');
    try {
        const x = JSON.parse(document.getElementById('heatmapX').textContent);
        const y = JSON.parse(document.getElementById('heatmapY').textContent);
        const z = JSON.parse(document.getElementById('heatmapZ').textContent);
        const x_labels = JSON.parse(document.getElementById('heatmapXLabels').textContent);
        const y_labels = JSON.parse(document.getElementById('heatmapYLabels').textContent);
        const zmax = {{ cluster_heatmap.zmax|default:100 }};

        // Validate data
        if (!x.length || !y.length || !z.length) {
            throw new Error('Missing heatmap data');
        }

        // Force minimum color contrast
        const colorscale = [
            [0, '#F0F0F0'],
            [0.01, '#FFEDA0'],  // Show faint color even for 1%
            [0.1, '#FEB24C'],
            [0.5, '#FC4E2A'],
            [1, '#B10026']
        ];

        Plotly.newPlot(heatmapDiv, [{
            x: x,
            y: y,
            z: z,
            type: 'heatmap',
            colorscale: colorscale,
            zmin: 0,
            zmax: zmax,
            hoverinfo: 'x+y+z',
            colorbar: {
                title: 'Probability (%)',
                tickformat: '.1f%'
            }
        }], {
            margin: {t: 30, b: 120, l: 120, r: 30},
            xaxis: {
                title: 'Items',
                tickangle: 45,
                tickvals: x,
                ticktext: x_labels,
                automargin: true
            },
            yaxis: {
                title: 'Users',
                tickvals: y,
                ticktext: y_labels,
                automargin: true
            }
        });

        messageDiv.textContent = `Displaying \${y.length} users and \${x.length} items`;

    } catch (error) {
        heatmapDiv.style.display = 'none';
        messageDiv.textContent = `Error loading heatmap: \${error.message}`;
        console.error('Heatmap error:', error);
    }

    const topPredictedItemsDiv = document.getElementById('topPredictedItemsChart');
    const topPredictedItemsMessageDiv = document.getElementById('topPredictedItemsMessage');
    try {
        const topPredictedItems = JSON.parse(document.getElementById('topPredictedItems').textContent);

        // Validate data
        if (!topPredictedItems.length) {
            throw new Error('Missing top predicted items data');
        }

        const users = topPredictedItems.map(item => item.user);
        const probabilities = topPredictedItems.map(item => item.probability);
        const items = topPredictedItems.map(item => item.item);

        Plotly.newPlot(topPredictedItemsDiv, [{
            x: users,
            y: probabilities,
            type: 'bar',
            hoverinfo: 'text',
            hovertext: items,
            text: items
        }], {
            margin: {t: 30, b: 120, l: 120, r: 30},
            xaxis: {
                title: 'User',
                tickangle: 45,
                automargin: true
            },
            yaxis: {
                title: 'Probability (%)',
                automargin: true
            }
        });

        topPredictedItemsMessageDiv.textContent = `Displaying top predicted items for \${users.length} users`;

    } catch (error) {
        topPredictedItemsDiv.style.display = 'none';
        topPredictedItemsMessageDiv.textContent = `Error loading top predicted items: \${error.message}`;
        console.error('Top predicted items error:', error);
    }

    const itemAffinityDiv = document.getElementById('itemAffinityChart');
    const itemAffinityMessageDiv = document.getElementById('itemAffinityMessage');
    try {
        const z = JSON.parse(document.getElementById('itemAffinityZ').textContent);
        const x = JSON.parse(document.getElementById('itemAffinityX').textContent);
        const y = JSON.parse(document.getElementById('itemAffinityY').textContent);

        // Validate data
        if (!z.length || !x.length || !y.length) {
            throw new Error('Missing item affinity data');
        }

        // Force minimum color contrast
        const colorscale = [
            [0, '#F0F0F0'],
            [0.01, '#FFEDA0'],  // Show faint color even for 1%
            [0.1, '#FEB24C'],
            [0.5, '#FC4E2A'],
            [1, '#B10026']
        ];

        Plotly.newPlot(itemAffinityDiv, [{
            z: z,
            x: x,
            y: y,
            type: 'heatmap',
            colorscale: colorscale,
            hoverinfo: 'x+y+z',
            colorbar: {
                title: 'Correlation',
                tickformat: '.2f'
            }
        }], {
            margin: {t: 30, b: 120, l: 120, r: 30},
            xaxis: {
                title: 'Item',
                tickangle: 45,
                automargin: true
            },
            yaxis: {
                title: 'Item',
                automargin: true
            }
        });

        itemAffinityMessageDiv.textContent = `Displaying item affinity for \${x.length} items`;

    } catch (error) {
        itemAffinityDiv.style.display = 'none';
        itemAffinityMessageDiv.textContent = `Error loading item affinity: \${error.message}`;
        console.error('Item affinity error:', error);
    }
});
</script>