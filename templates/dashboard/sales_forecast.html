{% extends "base.html" %}

{% block content %}
    <h2>Sale Forecast Dashboard</h2>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="dashboardTabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="?active_tab=dashboard-content#dashboard-content">Analytic Dashboard</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="?active_tab=top30-forecast#top30-forecast">Sales Forecast</a>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
         <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard-content">
            <div id="main-content">
                {% include "dashboard/partials/main_content.html" %}
            </div>
        </div>
         <!-- Top 30 Forecast Tab -->
        <div class="tab-pane fade" id="top30-forecast">
            {% include "dashboard/partials/top_30_sale_forecast_partial.html" %}
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Add this line -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


    <!-- Enable HTMX scripts -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            htmx.config.allowScripts = true;
        });
    </script>

    <!-- Chart initialization script -->
    <script>
    // Initialize charts
        function initCharts() {
            ['country-pie-plot', 'item-pie-plot'].forEach(id => {
                const element = document.getElementById(id);
                if (element && typeof Plotly !== 'undefined') {
                    // Purge existing plot before reinitializing
                    Plotly.purge(element);

                    // Extract data from Django template
                    const plotData = JSON.parse(element.getAttribute('data-plot'));
                    Plotly.newPlot(element, plotData.data, plotData.layout);
                }
            });
        }

        // Auto-resize handler
        function initResize(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const observer = new ResizeObserver(() => {
                Plotly.Plots.resize(container);
            });

            observer.observe(container);
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            ['country-pie-plot', 'item-pie-plot'].forEach(initResize);
        });

        // HTMX content swap handler
        document.addEventListener('htmx:afterSwap', function() {
            setTimeout(() => {
                initCharts();
                ['country-pie-plot', 'item-pie-plot'].forEach(initResize);
            }, 50);
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            ['country-pie-plot', 'item-pie-plot'].forEach(id => {
                const element = document.getElementById(id);
                if (element) Plotly.Plots.resize(element);
            });
        });
        </script>
{% endblock %}