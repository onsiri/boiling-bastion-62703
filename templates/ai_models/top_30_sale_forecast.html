<!-- templates/ai_models/top_30_sale_forecast.html -->
{% extends "base.html" %}
{% load humanize %}
{% block content %}
<head>
    <title>Top 30 Sales Forecast</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .sort-indicator {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            margin-left: 5px;
        }
        .sort-indicator.asc {
            border-bottom: 5px solid black;
        }
        .sort-indicator.desc {
            border-top: 5px solid black;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .pagination-list {
            list-style: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>30 Days Sales Forecast</h1>
            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}export=csv"
               class="btn btn-success">
                <i class="bi bi-download"></i> Export to CSV
            </a>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date <a href="?sort_by=ds&sort_order={% if sort_by == 'ds' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key,value in request.GET.items %}{% if key != 'sort_by' and key != 'sort_order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="sort-link"><span class="sort-indicator {% if sort_by == 'ds' %}{% if sort_order == 'asc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}"></span></a></th>
                                <th>Prediction <a href="?sort_by=prediction&sort_order={% if sort_by == 'prediction' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key,value in request.GET.items %}{% if key != 'sort_by' and key != 'sort_order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="sort-link"><span class="sort-indicator {% if sort_by == 'prediction' %}{% if sort_order == 'asc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}"></span></a></th>
                                <th>Prediction Lower <a href="?sort_by=prediction_lower&sort_order={% if sort_by == 'prediction_lower' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key,value in request.GET.items %}{% if key != 'sort_by' and key != 'sort_order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="sort-link"><span class="sort-indicator {% if sort_by == 'prediction_lower' %}{% if sort_order == 'asc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}"></span></a></th>
                                <th>Prediction Upper <a href="?sort_by=prediction_upper&sort_order={% if sort_by == 'prediction_upper' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key,value in request.GET.items %}{% if key != 'sort_by' and key != 'sort_order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="sort-link"><span class="sort-indicator {% if sort_by == 'prediction_upper' %}{% if sort_order == 'asc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}"></span></a></th>
                                <th>Uploaded At <a href="?sort_by=uploaded_at&sort_order={% if sort_by == 'uploaded_at' and sort_order == 'asc' %}desc{% else %}asc{% endif %}{% for key,value in request.GET.items %}{% if key != 'sort_by' and key != 'sort_order' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="sort-link"><span class="sort-indicator {% if sort_by == 'uploaded_at' %}{% if sort_order == 'asc' %}asc{% else %}desc{% endif %}{% else %}asc{% endif %}"></span></a></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in page_obj %}
                            <tr>
                                <td>{{ item.ds|date:"Y-m-d" }}</td>
                                <td>${{ item.prediction|intcomma }}</td>
                                <td>${{ item.prediction_lower|intcomma }}</td>
                                <td>${{ item.prediction_upper|intcomma }}</td>
                                <td>{{ item.uploaded_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No forecast data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="pagination mt-4">
                        <ul class="pagination-list d-flex flex-wrap gap-2 list-unstyled">
                            {% if page_obj.has_previous %}
                                <li>
                                    <a href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">&laquo;</a>
                                </li>
                                <li>
                                    <a href="?page={{ page_obj.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Prev</a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li>
                                        <span class="page-link active">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                                    <li>
                                        <a href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">{{ num }}</a>
                                    </li>
                                {% elif num == 1 or num == page_obj.paginator.num_pages %}
                                    <li>
                                        <a href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">{{ num }}</a>
                                    </li>
                                {% elif num == page_obj.number|add:-3 or num == page_obj.number|add:3 %}
                                    <li class="disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li>
                                    <a href="?page={{ page_obj.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Next</a>
                                </li>
                                <li>
                                    <a href="?page={{ page_obj.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">&raquo;</a>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    \$(document).ready(function() {
        \$('th .sort-link').click(function(e) {
            e.preventDefault();
            var url = \$(this).attr('href');

            \$.ajax({
                url: url,
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                success: function(data) {
                    \$('.table-responsive').html(\$(data).find('.table-responsive').html());
                    window.history.replaceState(null, null, url);
                }
            });
        });
    });
    </script>
</body>
{% endblock %}