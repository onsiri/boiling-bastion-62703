{# templates/admin/ai_models/transaction/change_list.html #}
{% extends "admin/ai_models/change_list.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<style>
    /* Custom spinner styles specific to TransactionAdmin */
    .spinner-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        z-index: 1000;
    }

    .transaction-spinner {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>
{% endblock %}

{% block object-tools-items %}
{{ block.super }}
<div class="spinner-overlay" id="transactionSpinner">
    <div class="transaction-spinner"></div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.querySelector('#bulkUploadForm');

        if(uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                const spinner = document.getElementById('transactionSpinner');
                spinner.style.display = 'block';

                // Keep spinner visible until redirect completes
                window.addEventListener('beforeunload', function() {
                    spinner.style.display = 'block';
                });
            });
        }

        // Hide spinner when page loads
        document.getElementById('transactionSpinner').style.display = 'none';

        // Use AJAX to submit the form
        document.getElementById('bulkUploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            var xhr = new XMLHttpRequest();
            xhr.open('POST', this.action, true);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    console.log('Job completed successfully');
                    document.getElementById('transactionSpinner').style.display = 'none';
                } else {
                    console.log('Error completing job');
                    document.getElementById('transactionSpinner').style.display = 'none';
                }
            };
            xhr.send(formData);
            document.getElementById('transactionSpinner').style.display = 'block';
        });
    });
</script>
{% endblock %}